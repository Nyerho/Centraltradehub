<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Your Account - Central Trade Hub</title>
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/ai-support-chat.css">
    
    <style>
        :root {
            --primary-color: #00d4ff;
            --primary-dark: #0099cc;
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #333333;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #444444;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .funding-container {
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .method-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
        }

        .method-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }

        .method-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #003d4d, #001a1f);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .method-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), #007399);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #1e7e34);
            border: none;
        }

        .form-control, .form-select {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
        }

        .form-control:focus, .form-select:focus {
            background: var(--bg-primary);
            border-color: var(--primary-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25);
        }

        .quick-amount {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-amount:hover {
            background: var(--primary-color);
            color: var(--bg-primary);
            border-color: var(--primary-color);
        }

        .crypto-address {
            font-family: 'Courier New', monospace;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            word-break: break-all;
            font-size: 0.9rem;
        }

        .copy-btn {
            background: var(--primary-color);
            color: var(--bg-primary);
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .copy-btn.success {
            background: var(--success-color);
            color: white;
        }

        .balance-display {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .balance-amount {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .transaction-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            border-color: var(--primary-color);
        }

        .status-pending {
            background: var(--warning-color);
            color: var(--bg-primary);
        }

        .status-completed {
            background: var(--success-color);
            color: white;
        }

        .status-failed {
            background: var(--danger-color);
            color: white;
        }

        .back-button {
            background: var(--bg-secondary);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            text-decoration: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-button:hover {
            background: var(--primary-color);
            color: var(--bg-primary);
            text-decoration: none;
        }

        .alert-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--text-primary);
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid var(--success-color);
            color: var(--text-primary);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--warning-color);
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .funding-container {
                padding: 1rem 0;
            }
            
            .method-icon {
                font-size: 2.5rem;
            }
            
            .balance-amount {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="funding-container">
        <div class="container">
            <!-- Back Button -->
            <div class="row mb-4">
                <div class="col-12">
                    <a href="dashboard.html" class="back-button">
                        <i class="fas fa-arrow-left"></i>
                        Back to Dashboard
                    </a>
                </div>
            </div>

            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12 text-center">
                    <h1 class="display-4 mb-3">
                        <i class="fas fa-wallet text-primary"></i>
                        Fund Your Trading Account
                    </h1>
                    <p class="lead text-secondary">Choose your preferred funding method and add money to start trading</p>
                </div>
            </div>

            <!-- Current Balance -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="balance-display">
                        <h3 class="mb-2">Current Balance</h3>
                        <div class="balance-amount" id="current-balance">$0.00</div>
                    </div>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="fas fa-credit-card"></i> Select Payment Method</h4>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-lg-3 col-md-6">
                                    <div class="method-card p-3 text-center h-100" data-method="stripe">
                                        <div class="method-icon">
                                            <i class="fas fa-credit-card"></i>
                                        </div>
                                        <h5>Credit/Debit Card</h5>
                                        <div class="small text-secondary">
                                            <div><strong>Processing:</strong> Instant</div>
                                            <div><strong>Fees:</strong> 2.9% + $0.30</div>
                                            <div><strong>Limits:</strong> $10 - $50,000</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="method-card p-3 text-center h-100" data-method="paypal">
                                        <div class="method-icon">
                                            <i class="fab fa-paypal"></i>
                                        </div>
                                        <h5>PayPal</h5>
                                        <div class="small text-secondary">
                                            <div><strong>Processing:</strong> Instant</div>
                                            <div><strong>Fees:</strong> 3.49% + $0.49</div>
                                            <div><strong>Limits:</strong> $5 - $10,000</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="method-card p-3 text-center h-100" data-method="crypto">
                                        <div class="method-icon">
                                            <i class="fab fa-bitcoin"></i>
                                        </div>
                                        <h5>Cryptocurrency</h5>
                                        <div class="small text-secondary">
                                            <div><strong>Processing:</strong> 10-60 minutes</div>
                                            <div><strong>Fees:</strong> Network fees only</div>
                                            <div><strong>Limits:</strong> $25 - $100,000</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="method-card p-3 text-center h-100" data-method="wire">
                                        <div class="method-icon">
                                            <i class="fas fa-university"></i>
                                        </div>
                                        <h5>Bank Wire Transfer</h5>
                                        <div class="small text-secondary">
                                            <div><strong>Processing:</strong> 1-3 business days</div>
                                            <div><strong>Fees:</strong> $25 flat fee</div>
                                            <div><strong>Limits:</strong> $1,000 - $1,000,000</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Amount Selection -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="fas fa-dollar-sign"></i> Enter Amount</h4>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-8">
                                    <input type="number" class="form-control form-control-lg" id="funding-amount" 
                                           min="5" step="0.01" placeholder="Enter amount">
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select form-select-lg" id="currency">
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="GBP">GBP</option>
                                        <option value="CAD">CAD</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn quick-amount" data-amount="100">$100</button>
                                <button class="btn quick-amount" data-amount="500">$500</button>
                                <button class="btn quick-amount" data-amount="1000">$1,000</button>
                                <button class="btn quick-amount" data-amount="5000">$5,000</button>
                                <button class="btn quick-amount" data-amount="10000">$10,000</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Forms -->
            <!-- Stripe Payment Form -->
            <div id="stripe-form" class="payment-form" style="display: none;">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="fas fa-credit-card"></i> Credit/Debit Card Payment</h4>
                            </div>
                            <div class="card-body">
                                <div id="stripe-card-element" class="mb-3"></div>
                                <button id="stripe-submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-lock"></i> Process Card Payment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PayPal Payment Form -->
            <div id="paypal-form" class="payment-form" style="display: none;">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="fab fa-paypal"></i> PayPal Payment</h4>
                            </div>
                            <div class="card-body">
                                <div id="paypal-button-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crypto Payment Form -->
            <div id="crypto-form" class="payment-form" style="display: none;">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="fab fa-bitcoin"></i> Cryptocurrency Payment</h4>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Select Cryptocurrency</label>
                                    <select class="form-select" id="crypto-currency">
                                        <option value="BTC">Bitcoin (BTC)</option>
                                        <option value="ETH">Ethereum (ETH)</option>
                                        <option value="LTC">Litecoin (LTC)</option>
                                        <option value="XRP">XRP (XRP)</option>
                                        <option value="SOL">Solana (SOL)</option>
                                        <option value="USDC">USD Coin (USDC) - ETH Network</option>
                                        <option value="USDC-SOL">USD Coin (USDC) - SOL Network</option>
                                        <option value="USDT">Tether (USDT) - ETH Network</option>
                                    </select>
                                </div>
                                <button id="crypto-generate" class="btn btn-primary btn-lg w-100 mb-3">
                                    <i class="fas fa-qrcode"></i> Generate Payment Address
                                </button>
                                
                                <!-- Payment Instructions -->
                                <div id="crypto-instructions" style="display: none;">
                                    <div class="alert alert-info">
                                        <h5><i class="fas fa-info-circle"></i> Payment Instructions</h5>
                                        <p class="mb-0">Send the exact amount to the address below. Your deposit will be processed after admin approval.</p>
                                    </div>
                                    
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Amount to Send:</strong></label>
                                            <div class="crypto-address" id="crypto-amount"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Network Fee:</strong></label>
                                            <div class="crypto-address" id="crypto-fee"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Wallet Address:</strong></label>
                                        <div class="d-flex gap-2">
                                            <div class="crypto-address flex-grow-1" id="crypto-address"></div>
                                            <button class="copy-btn" onclick="copyToClipboard('crypto-address')">
                                                <i class="fas fa-copy"></i> Copy
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center mb-3">
                                        <img id="crypto-qr" alt="QR Code" class="img-fluid" style="max-width: 200px; border-radius: 8px;">
                                    </div>
                                    
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>Important:</strong> Only send the selected cryptocurrency to this address. 
                                        Sending other cryptocurrencies may result in permanent loss.
                                    </div>
                                    
                                    <button id="crypto-confirm-sent" class="btn btn-success btn-lg w-100">
                                        <i class="fas fa-check-circle"></i> I have sent the payment
                                    </button>
                                </div>
                                
                                <!-- Confirmation Step -->
                                <div id="crypto-confirmation" style="display: none;">
                                    <div class="alert alert-success">
                                        <h5><i class="fas fa-check-circle"></i> Payment Confirmation</h5>
                                        <p class="mb-0">Your payment confirmation has been received and is pending admin approval. 
                                        You will be notified once your deposit is processed.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wire Transfer Form -->
            <div id="wire-form" class="payment-form" style="display: none;">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0"><i class="fas fa-university"></i> Bank Wire Transfer</h4>
                            </div>
                            <div class="card-body">
                                <button id="wire-generate" class="btn btn-primary btn-lg w-100 mb-3">
                                    <i class="fas fa-file-alt"></i> Get Wire Instructions
                                </button>
                                
                                <div id="wire-instructions" style="display: none;">
                                    <div class="alert alert-info">
                                        <h5><i class="fas fa-info-circle"></i> Wire Transfer Instructions</h5>
                                        <p class="mb-0">Use the following details for your wire transfer. Include the reference number to ensure proper processing.</p>
                                    </div>
                                    
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Bank Name:</strong></label>
                                            <div class="crypto-address">Central Trade Bank</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Account Name:</strong></label>
                                            <div class="crypto-address">Central Trade Hub LLC</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Account Number:</strong></label>
                                            <div class="crypto-address">1234567890</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Routing Number:</strong></label>
                                            <div class="crypto-address">021000021</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>SWIFT Code:</strong></label>
                                            <div class="crypto-address">CTBKUS33</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><strong>Reference:</strong></label>
                                            <div class="crypto-address" id="wire-reference"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0"><i class="fas fa-history"></i> Transaction History</h4>
                        </div>
                        <div class="card-body">
                            <div id="transaction-list">
                                <p class="text-center text-secondary">No transactions yet. Make your first deposit above!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase and App Scripts -->
    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/firebase-database.js"></script>
    <script type="module" src="js/auth-integration.js"></script>
    <script type="module" src="js/funding-manager.js"></script>
    <script type="module" src="js/ai-support-chat.js"></script>
    
    <script>
        // Global variables
        let selectedMethod = null;
        let currentAmount = 0;
        let currentCurrency = 'USD';
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for authManager to be available
            setTimeout(() => {
                initializeFundingPage();
            }, 1000);
        });
        
        function initializeFundingPage() {
            // Load current balance
            loadCurrentBalance();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load transaction history
            setTimeout(() => {
                loadTransactionHistory();
            }, 1000);
        }
        
        function setupEventListeners() {
            // Payment method selection
            document.querySelectorAll('.method-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectPaymentMethod(this.dataset.method);
                });
            });
            
            // Quick amount buttons
            document.querySelectorAll('.quick-amount').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('funding-amount').value = this.dataset.amount;
                    currentAmount = parseFloat(this.dataset.amount);
                });
            });
            
            // Amount input
            document.getElementById('funding-amount').addEventListener('input', function() {
                currentAmount = parseFloat(this.value) || 0;
            });
            
            // Currency selection
            document.getElementById('currency').addEventListener('change', function() {
                currentCurrency = this.value;
            });
            
            // Crypto generate button
            document.getElementById('crypto-generate').addEventListener('click', generateCryptoPayment);
            
            // Crypto confirmation button
            document.getElementById('crypto-confirm-sent').addEventListener('click', confirmCryptoPayment);
            
            // Wire generate button
            document.getElementById('wire-generate').addEventListener('click', generateWireInstructions);
        }
        
        function selectPaymentMethod(method) {
            // Remove previous selections
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Hide all payment forms
            document.querySelectorAll('.payment-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Select new method
            document.querySelector(`[data-method="${method}"]`).classList.add('selected');
            selectedMethod = method;
            
            // Show corresponding form
            document.getElementById(`${method}-form`).style.display = 'block';
            
            // Scroll to form
            document.getElementById(`${method}-form`).scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
        
        async function generateCryptoPayment() {
            if (!currentAmount || currentAmount < 25) {
                showAlert('Please enter an amount of at least $25', 'warning');
                return;
            }
            
            const currency = document.getElementById('crypto-currency').value;
            
            try {
                // Show loading state
                const btn = document.getElementById('crypto-generate');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                btn.disabled = true;
                
                // Generate payment details
                const paymentDetails = await window.fundingManager.processCryptoPayment({
                    amount: currentAmount,
                    currency: currency
                });
                
                // Display payment instructions
                document.getElementById('crypto-amount').textContent = `${currentAmount} ${currentCurrency} (â‰ˆ ${paymentDetails.amount} ${currency})`;
                document.getElementById('crypto-address').textContent = paymentDetails.address;
                document.getElementById('crypto-fee').textContent = paymentDetails.network_fee;
                document.getElementById('crypto-qr').src = paymentDetails.qr_code;
                
                // Show instructions
                document.getElementById('crypto-instructions').style.display = 'block';
                
                // Hide generate button
                btn.style.display = 'none';
                
            } catch (error) {
                console.error('Error generating crypto payment:', error);
                showAlert('Error generating payment address. Please try again.', 'danger');
                
                // Reset button
                const btn = document.getElementById('crypto-generate');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function confirmCryptoPayment() {
            const btn = document.getElementById('crypto-confirm-sent');
            const originalText = btn.innerHTML; // Move this outside try block
            
            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                btn.disabled = true;
                
                const currency = document.getElementById('crypto-currency').value;
                const address = document.getElementById('crypto-address').textContent;
                
                // Confirm payment with funding manager
                const result = await window.fundingManager.confirmCryptoPayment({
                    amount: currentAmount,
                    currency: currency,
                    address: address
                });
                
                // Hide instructions and show confirmation
                document.getElementById('crypto-instructions').style.display = 'none';
                document.getElementById('crypto-confirmation').style.display = 'block';
                
                // Show success message
                showAlert('Payment confirmation submitted successfully! Your deposit is pending admin approval.', 'success');
                
                // Refresh transaction history
                setTimeout(() => {
                    loadTransactionHistory();
                }, 2000);
                
            } catch (error) {
                console.error('Error confirming payment:', error);
                showAlert('Error confirming payment. Please try again.', 'danger');
                
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function generateWireInstructions() {
            if (!currentAmount || currentAmount < 1000) {
                showAlert('Minimum wire transfer amount is $1,000', 'warning');
                return;
            }
            
            // Generate unique reference
            const reference = `CTH-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
            document.getElementById('wire-reference').textContent = reference;
            
            // Show instructions
            document.getElementById('wire-instructions').style.display = 'block';
            document.getElementById('wire-generate').style.display = 'none';
        }
        
        async function loadCurrentBalance() {
            try {
                // Wait for authManager to be available
                if (!window.authManager) {
                    setTimeout(loadCurrentBalance, 500);
                    return;
                }
                
                if (window.authManager && window.authManager.getCurrentUser()) {
                    const user = window.authManager.getCurrentUser();
                    
                    // Import Firebase functions
                    const { db } = await import('./js/firebase-config.js');
                    const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        const balance = userData.balance || userData.walletBalance || 0;
                        document.getElementById('current-balance').textContent = 
                            `$${balance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    } else {
                        document.getElementById('current-balance').textContent = '$0.00';
                    }
                } else {
                    document.getElementById('current-balance').textContent = '$0.00';
                }
            } catch (error) {
                console.error('Error loading balance:', error);
                document.getElementById('current-balance').textContent = '$0.00';
            }
        }
        
        function loadTransactionHistory() {
            if (!window.fundingManager) {
                setTimeout(loadTransactionHistory, 1000);
                return;
            }
            
            const transactions = window.fundingManager.getTransactionHistory();
            const listElement = document.getElementById('transaction-list');
            
            if (transactions.length === 0) {
                listElement.innerHTML = '<p class="text-center text-secondary">No transactions yet. Make your first deposit above!</p>';
                return;
            }
            
            listElement.innerHTML = transactions.map(tx => `
                <div class="transaction-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${tx.method.toUpperCase()} - ${tx.amount} ${tx.currency}</h6>
                            <small class="text-secondary">${new Date(tx.timestamp).toLocaleString()}</small>
                        </div>
                        <span class="badge status-${tx.status} px-3 py-2">
                            ${tx.status.toUpperCase()}
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const textToCopy = element.textContent || element.innerText;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showCopySuccess();
                }).catch(err => {
                    fallbackCopyTextToClipboard(textToCopy);
                });
            } else {
                fallbackCopyTextToClipboard(textToCopy);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                }
            } catch (err) {
                console.error('Copy failed:', err);
            }
            
            document.body.removeChild(textArea);
        }
        
        function showCopySuccess() {
            const copyBtn = document.querySelector('.copy-btn');
            if (copyBtn) {
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                copyBtn.classList.add('success');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('success');
                }, 2000);
            }
        }
        
        function showAlert(message, type) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>